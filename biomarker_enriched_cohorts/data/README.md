# TCGA-OV Outcome-Labeled Cohort Documentation

**Version:** v1  
**Last Updated:** January 1, 2026  
**Owner:** JR (Data/Backend)

---

## Overview

This directory contains **outcome-labeled, real-cohort artifacts** for TCGA-OV (ovarian cancer) that power "Cohort Context" benchmarking (RUO) with **receipt-driven reproducibility**.

## Files

### Base Cohort
- **`tcga_ov_outcomes_v1.json`** - Base outcome-labeled cohort with OS/PFS endpoints
  - Generated by: `scripts/cohorts/extract_tcga_outcomes.py`
  - Contains: `os_days`, `os_event`, `pfs_days`, `pfs_event`, PFI proxy

### Enriched Cohort
- **`tcga_ov_outcomes_v1_enriched.json`** - Enriched cohort with biomarker fields
  - Generated by: `scripts/cohorts/enrich_tcga_ov_biomarkers.py`
  - Contains: All base fields + `hrd_score`, `tmb`, `msi_status`, `germline_brca_status`

### Receipts
- **`receipts/tcga_ov_outcomes_v1_receipt_YYYYMMDD.json`** - Base cohort extraction receipt
- **`receipts/tcga_ov_outcomes_v1_enriched_receipt_YYYYMMDD.json`** - Enrichment receipt

---

## Schema

### Base Cohort Schema

```json
{
  "cohort": {
    "source": "cbioportal",
    "study_id": "ov_tcga_pan_can_atlas_2018",
    "disease": "ovarian_cancer",
    "patients": [
      {
        "patient_id": "TCGA-XX-XXXX",
        "outcomes": {
          "os_days": 1234,
          "os_event": true,
          "pfs_days": 567,
          "pfs_event": false,
          "pfi": {
            "pfi_days": 567,
            "pfi_resistant": true,
            "pfi_source": "pfs_proxy",
            "note": "PFI estimated from PFS (progression < 6 months)"
          }
        }
      }
    ],
    "metadata": {
      "extraction_date": "2026-01-01T00:00:00",
      "label_definitions_version": "v1",
      "time_origin": "diagnosis_date",
      "censoring_policy": "Standard survival analysis: events = 1, censored = 0",
      "sources": [...],
      "completeness": {...}
    }
  }
}
```

### Enriched Cohort Schema

```json
{
  "cohort": {
    ...base_cohort_fields...,
    "patients": [
      {
        "patient_id": "TCGA-XX-XXXX",
        "outcomes": {...},
        "biomarkers": {
          "hrd_score": 45.2,
          "tmb": 3.5,
          "msi_status": "MSS",
          "germline_brca_status": "unknown"
        }
      }
    ],
    "metadata": {
      ...base_metadata...,
      "enrichment_date": "2026-01-01T00:00:00",
      "enrichment_version": "v1",
      "biomarker_sources": {...},
      "biomarker_coverage": {...}
    }
  }
}
```

---

## Field Definitions

### Outcome Fields

#### `os_days` (int, optional)
- **Definition:** Overall survival in days from diagnosis
- **Source:** `OS_MONTHS` × 30.44 (standard conversion)
- **Range:** 0-5000 days (outliers allowed but counted)
- **Missing:** `null` if OS_MONTHS unavailable

#### `os_event` (bool, optional)
- **Definition:** Death event indicator (1 = deceased, 0 = alive/censored)
- **Source:** Parsed from `OS_STATUS` (0:LIVING → 0, 1:DECEASED → 1)
- **Missing:** `null` if OS_STATUS unavailable

#### `pfs_days` (int, optional)
- **Definition:** Progression-free survival in days from diagnosis
- **Source:** `PFS_MONTHS` × 30.44 (or estimated from DFS/OS if missing)
- **Range:** 0-5000 days
- **Missing:** `null` if PFS_MONTHS unavailable and cannot be estimated

#### `pfs_event` (bool, optional)
- **Definition:** Progression event indicator (1 = progressed, 0 = censored)
- **Source:** Parsed from `PFS_STATUS` (0:CENSORED → 0, 1:PROGRESSION → 1)
- **Missing:** `null` if PFS_STATUS unavailable

#### `pfi` (object, optional)
- **Definition:** Platinum-Free Interval proxy
- **Fields:**
  - `pfi_days` (int): Time from treatment to progression (if progression < 6 months)
  - `pfi_resistant` (bool): True if PFI < 6 months (platinum-resistant)
  - `pfi_source` (string): "pfs_proxy" or "treatment_dates"
  - `note` (string): Explanation of calculation method
- **Missing:** `null` if cannot be calculated

### Biomarker Fields (Enriched Cohort)

#### `hrd_score` (float, optional)
- **Definition:** Homologous Recombination Deficiency score
- **Source:** 
  - Primary: cBioPortal clinical attributes (HRD_SCORE, GIS_SCORE, etc.)
  - Fallback: GISTIC copy-number data (proxy calculation)
- **Range:** 0-100 (cohort-native scale)
- **Threshold:** HRD+ typically ≥42
- **Missing:** `null` if unavailable

#### `tmb` (float, optional)
- **Definition:** Tumor Mutational Burden (mutations per megabase)
- **Source:** `TMB_NONSYNONYMOUS` from cBioPortal clinical data
- **Denominator:** 38.0 Mb (TCGA WES exome size)
- **Range:** 0-500 mut/Mb (outliers allowed)
- **Missing:** `null` if TMB_NONSYNONYMOUS unavailable

#### `msi_status` (string, optional)
- **Definition:** Microsatellite Instability status
- **Source:** `MSI_SCORE_MANTIS` or `MSI_STATUS` from cBioPortal
- **Values:** `"MSI-H"`, `"MSS"`, `"Unknown"`, or `null`
- **Missing:** `null` if unavailable

#### `germline_brca_status` (string)
- **Definition:** Germline BRCA1/BRCA2 mutation status
- **Source:** Defaults to `"unknown"` (germline testing not available in TCGA)
- **Values:** `"positive"`, `"negative"`, `"unknown"`
- **Note:** Somatic BRCA mutations may be present but do not indicate germline status

---

## Label Definitions Version Policy

- **Version:** `v1` (current)
- **Time Origin:** `diagnosis_date` (TCGA standard)
- **Censoring Policy:** Standard survival analysis (events = 1, censored = 0)
- **Reproducibility:** Running extractors twice produces identical cohort JSON (except receipt timestamps)

---

## Usage

### Step 1: Extract Base Cohort

```bash
cd oncology-coPilot/oncology-backend-minimal
python3 scripts/cohorts/extract_tcga_outcomes.py
```

**Output:**
- `data/cohorts/tcga_ov_outcomes_v1.json`
- `data/cohorts/receipts/tcga_ov_outcomes_v1_receipt_YYYYMMDD.json`

### Step 2: Enrich with Biomarkers

```bash
python3 scripts/cohorts/enrich_tcga_ov_biomarkers.py
```

**Prerequisites:**
- Base cohort must exist (`tcga_ov_outcomes_v1.json`)

**Output:**
- `data/cohorts/tcga_ov_outcomes_v1_enriched.json`
- `data/cohorts/receipts/tcga_ov_outcomes_v1_enriched_receipt_YYYYMMDD.json`

---

## Acceptance Criteria

### Base Cohort
- ✅ **Reproducibility:** Deterministic output (except timestamps)
- ✅ **Scale:** N ≥ 400 patients with OS labels
- ✅ **Completeness:** Receipt reports missingness for OS/PFS
- ✅ **Validation:** `0 <= os_days <= 5000`, `os_event` is boolean

### Enriched Cohort
- ✅ **Reproducibility:** Deterministic output (except timestamps)
- ✅ **HRD Coverage:** Receipt reports `n_with_hrd` and % missing
- ✅ **TMB Coverage:** Receipt reports `n_with_tmb` and denominator (38 Mb)
- ✅ **MSI Coverage:** Receipt reports `n_with_msi_status`
- ✅ **No Overclaims:** MSI/germline set to `null`/`unknown` if unavailable

---

## Data Sources

### Primary Source
- **cBioPortal:** `ov_tcga_pan_can_atlas_2018` study
- **API:** `https://www.cbioportal.org/api`
- **Authentication:** Optional (CBIO_TOKEN env var)

### Field Mappings

| Field | cBioPortal Source | Conversion |
|-------|------------------|------------|
| `os_days` | `OS_MONTHS` | × 30.44 |
| `os_event` | `OS_STATUS` | Parse (0:LIVING → 0, 1:DECEASED → 1) |
| `pfs_days` | `PFS_MONTHS` | × 30.44 |
| `pfs_event` | `PFS_STATUS` | Parse (0:CENSORED → 0, 1:PROGRESSION → 1) |
| `hrd_score` | `HRD_SCORE`, `GIS_SCORE` (or GISTIC proxy) | Direct or calculated |
| `tmb` | `TMB_NONSYNONYMOUS` | Direct (mutations/Mb) |
| `msi_status` | `MSI_SCORE_MANTIS`, `MSI_STATUS` | Parse (MSI-H/MSS/Unknown) |
| `germline_brca_status` | N/A | Default: "unknown" |

---

## Notes

1. **HRD Scores:** If not available in clinical attributes, script attempts GISTIC-based proxy calculation (see `tools/benchmarks/extract_gistic_hrd.py`)

2. **TMB Calculation:** Uses standard TCGA WES exome size (38.0 Mb). If `TMB_NONSYNONYMOUS` unavailable, could calculate from mutations (not implemented in v1).

3. **Germline BRCA:** TCGA typically has somatic mutations only. Germline testing not available. Defaults to "unknown" to avoid overclaims.

4. **PFI Proxy:** Calculated from PFS when progression < 6 months. True PFI requires treatment dates (not always available).

5. **Reproducibility:** All scripts are deterministic. Running twice produces identical results (except receipt timestamps).

---

## Troubleshooting

### Base Cohort Not Found
**Error:** `FileNotFoundError: Base cohort not found`  
**Solution:** Run `extract_tcga_outcomes.py` first

### No HRD Scores Extracted
**Warning:** `No HRD attributes found in clinical data`  
**Solution:** Script will attempt GISTIC-based extraction. If that fails, HRD scores will be `null` (acceptable per acceptance criteria).

### API Rate Limiting
**Error:** `429 Too Many Requests`  
**Solution:** Script includes rate limiting (1s delay). If persistent, increase `API_DELAY` in script.

---

## Contact

For questions or issues, contact JR (Data/Backend) or refer to:
- Mission doc: `.cursor/rules/agents/AGENT_JR_OUTCOME_LABELED_COHORT_CONTEXT.mdc`
- Enrichment doc: `.cursor/rules/agents/AGENT_JR_COHORT_ENRICHMENT_HRD_TMB_MSI.mdc`

